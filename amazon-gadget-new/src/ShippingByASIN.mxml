<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml"
				width="100%"
				height="100%"
				backgroundColor="white"
				paddingBottom="2"
				paddingLeft="2"
				paddingRight="2"
				paddingTop="2"
				horizontalAlign="left"
				verticalScrollPolicy="off"
				horizontalScrollPolicy="off"
				creationComplete="{init()}"
				xmlns:components="components.*"
				xmlns:services="services.*">
	<mx:Style source="styles.css"/>
	<services:AmazonSearchService id="amazonSearchService"
								  searchDTO="{searchDTO}"
								  keyword="{asin}"
								  category="{null}"
								  page="{page}"
								  result="{amazonSearchResultHandler(event)}"/>

	<components:CheckAvailabilityBox id="checkAvailabilityBox"
									 dataProvider="{searchItemDTO}"
									 region="{region}"
									 searchDTO="{searchDTO}"/>
	<mx:Script>
		<![CDATA[
			import dto.SearchDTO;
			import dto.SearchItemDTO;
			[Bindable]
			private var asin:String;
			[Bindable]
			private var region:String;
			[Bindable]
			private var page:int=1;
			[Bindable]
			private var keyword:String="";
			[Bindable]
			private var searchDTO:SearchDTO;
			[Bindable]
			private var searchItemDTO:SearchItemDTO;

			private function init():void
			{
				var params:Dictionary=getUrlParamateres();
				asin=params["asin"];
				region=params["region"];
				//amazonSearchService.sendRequest();
				searchItemDTO = new SearchItemDTO();
				searchItemDTO.id = asin;
				searchDTO = new SearchDTO();
				searchDTO.searchItems.addItem(searchItemDTO);
				checkAvailabilityBox.checkAvailabilityClickHandler(null);
			}

			private function getUrlParamateres():Dictionary
			{
				var urlParams:Dictionary=new Dictionary();
				var fullUrl:String=ExternalInterface.call('eval', 'document.location.href');
				var paramStr:String=fullUrl.split('?')[1];
				if (paramStr != null)
				{
					var params:Array=paramStr.split('&');
					for(var i:int=0; i < params.length; i++)
					{
						var kv:Array=params[i].split('=');
						urlParams[kv[0]]=kv[1];
					}
				}
				return urlParams;
			}

			private function amazonSearchResultHandler(event:Event):void
			{
				if (amazonSearchService.searchDTO.searchItems.length > 0)
				{
					searchDTO=amazonSearchService.searchDTO;
					searchItemDTO=searchDTO.searchItems.getItemAt(0)as SearchItemDTO;
					checkAvailabilityBox.checkAvailabilityClickHandler(null);
				}
			}
		]]>
	</mx:Script>
</mx:Application>
